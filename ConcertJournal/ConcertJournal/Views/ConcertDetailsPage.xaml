<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ConcertJournal.Views.ConcertDetailsPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
             xmlns:controls="clr-namespace:ConcertJournal.Views.Controls"
             xmlns:vm="clr-namespace:ConcertJournal.ViewModels"
             x:DataType="vm:ConcertDetailsViewModel"
             x:Name="ConcertDetails"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{DynamicResource Background}">

    <Grid RowDefinitions="*,Auto">
        <Grid Grid.RowSpan="2">
            <Image Source="{DynamicResource DetailsBackground}" 
                   Aspect="AspectFill" 
                   Opacity="0.4"/>
            <BoxView BackgroundColor="{DynamicResource Background}" Opacity="0.6"/>
        </Grid>

        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="25">

                <Grid ColumnDefinitions="*,Auto">
                    <ImageButton Grid.Column="0"
                                 Source="{DynamicResource DoubleLeftArrowIcon}"
                                 HorizontalOptions="Start"
                                 Command="{Binding GoBackCommand}"
                                 HeightRequest="30"/>

                    <HorizontalStackLayout Grid.Column="1" Spacing="15">
                        <ImageButton Source="{DynamicResource EditIcon}"
                                     Command="{Binding EditConcertCommand}"
                                     HeightRequest="24"/>
                        <ImageButton Source="{DynamicResource DeleteIcon}"
                                     Command="{Binding DeleteConcertCommand}"
                                     HeightRequest="24"/>
                    </HorizontalStackLayout>
                </Grid>

                <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                    <Label Text="{Binding Concert.EventTitle}"
                           FontSize="34"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Primary}"
                           HorizontalTextAlignment="Center"
                           CharacterSpacing="1"/>

                    <Label Text="{Binding Concert.Date, StringFormat='{0:MMMM dd, yyyy}'}"
                           FontSize="18"
                           TextColor="{DynamicResource Secondary}"
                           HorizontalOptions="Center"
                           FontAttributes="Italic"/>

                    <toolkit:RatingView Rating="{Binding Concert.Rating}"
                                       HorizontalOptions="Center"
                                       FillColor="{DynamicResource RatingFill}"
                                       IsReadOnly="True"
                                       ShapeDiameter="28"
                                       Spacing="5"
                                       Margin="0,10,0,0"/>
                </VerticalStackLayout>

                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <Border Grid.Column="0" Padding="15" StrokeShape="RoundRectangle 12" BackgroundColor="{DynamicResource Surface}">
                        <VerticalStackLayout Spacing="5" HorizontalOptions="Center">
                            <Label Text="PERFORMERS" FontSize="10" FontAttributes="Bold" TextColor="Gray" HorizontalOptions="Center"/>
                            <Label Text="{Binding Concert.Performers}" FontSize="16" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                            <Label Text="View Profile" FontSize="10" TextColor="{DynamicResource Primary}" HorizontalOptions="Center" TextDecorations="Underline">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding PerformerTappedCommand}"/>
                                </Label.GestureRecognizers>
                            </Label>
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Column="1" Padding="15" StrokeShape="RoundRectangle 12" BackgroundColor="{DynamicResource Surface}">
                        <VerticalStackLayout Spacing="5" HorizontalOptions="Center">
                            <Label Text="VENUE" FontSize="10" FontAttributes="Bold" TextColor="Gray" HorizontalOptions="Center"/>
                            <Label Text="{Binding Concert.Venue}" FontSize="15" HorizontalTextAlignment="Center" FontAttributes="Bold" LineBreakMode="TailTruncation"/>
                            <Label Text="{Binding Concert.Location}" FontSize="12" HorizontalTextAlignment="Center" Opacity="0.8"/>
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <VerticalStackLayout Spacing="10">
                    <Label Text="MY MEMORIES" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Secondary}" CharacterSpacing="2"/>
                    <Border Padding="20" StrokeShape="RoundRectangle 12" BackgroundColor="{DynamicResource Surface}" StrokeThickness="0.5" Stroke="{DynamicResource Primary}">
                        <Label Text="{Binding Concert.Notes}" 
                               FontSize="16" 
                               LineHeight="1.4"
                               TextColor="{DynamicResource TextColor}"/>
                    </Border>
                </VerticalStackLayout>

                <VerticalStackLayout Spacing="15">
                    <VerticalStackLayout.Triggers>
                        <DataTrigger TargetType="VerticalStackLayout" 
                             Binding="{Binding MediaFiles.Count}" 
                             Value="0">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </VerticalStackLayout.Triggers>
                    
                    <Label Text="PHOTOS" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Secondary}" CharacterSpacing="2"/>

                    <CarouselView ItemsSource="{Binding MediaFiles}"
                                  IndicatorView="indicatorView"
                                  HeightRequest="350"
                                  PeekAreaInsets="30">
                        <CarouselView.ItemTemplate>
                            <DataTemplate x:DataType="sys:String">
                                <Border Margin="5" StrokeShape="RoundRectangle 20" StrokeThickness="0">
                                    <Grid>
                                        <Image Source="{Binding .}" Aspect="AspectFill">
                                            <Image.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={x:Reference ConcertDetails}, Path=BindingContext.OpenZoomImageCommand}"
                                                                      CommandParameter="{Binding .}"/>
                                            </Image.GestureRecognizers>
                                        </Image>
                                        <BoxView VerticalOptions="End" HeightRequest="60">
                                            <BoxView.Background>
                                                <LinearGradientBrush EndPoint="0,1">
                                                    <GradientStop Color="Transparent" Offset="0"/>
                                                    <GradientStop Color="#CC000000" Offset="1"/>
                                                </LinearGradientBrush>
                                            </BoxView.Background>
                                        </BoxView>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CarouselView.ItemTemplate>
                    </CarouselView>

                    <IndicatorView x:Name="indicatorView"
                                   IndicatorColor="Gray"
                                   SelectedIndicatorColor="{DynamicResource Primary}"
                                   HorizontalOptions="Center"/>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <controls:BottomNavBar Grid.Row="1" />
    </Grid>
</ContentPage>